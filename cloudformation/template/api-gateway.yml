AWSTemplateFormatVersion: '2010-09-09'
Description: |
  CloudFormation template for deploying the orders REST API Gateway.
  This template creates an API Gateway with a VPC Link to a Network Load Balancer.

Parameters:
  ApplicationName:
    Type: String
    Description: The name of the application.

Resources:
  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !ImportValue ApiGatewayCloudWatchLogsRoleArn

  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/api-gateway/${ApplicationName}
      RetentionInDays: 7

  ApiGatewayVpcLink:
    Type: AWS::ApiGateway::VpcLink
    Properties:
      Name: !Sub '${ApplicationName}-vpc-link'
      TargetArns:
        - Fn::ImportValue:
            !Sub "${ApplicationName}-NlbArn"

  OrdersRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'Orders AWS API Gateway'
      Description: API Gateway for Orders API
      EndpointConfiguration:
        Types:
          - REGIONAL
      Parameters:
        nlb_dns: !ImportValue LoadBalancerDNS
        vpc_link_id: !Ref ApiGatewayVpcLink
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: execute-api:Invoke
            Resource: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*

  ProxyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref OrdersRestApi
      ParentId: !GetAtt OrdersRestApi.RootResourceId
      PathPart: '{proxy+}'

  ProxyMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref OrdersRestApi
      ResourceId: !Ref ProxyResource
      HttpMethod: ANY
      AuthorizationType: NONE
      RequestParameters:
        method.request.path.proxy: true
      Integration:
        Type: HTTP_PROXY
        IntegrationHttpMethod: ANY
        Uri: !Sub
          - 'http://${NlbDns}/{proxy}'
          - { NlbDns: !ImportValue LoadBalancerDNS }
        ConnectionType: VPC_LINK
        ConnectionId: !Ref ApiGatewayVpcLink
        RequestParameters:
          integration.request.path.proxy: method.request.path.proxy

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - OrdersRestApi
      - ProxyMethod
    Properties:
      RestApiId: !Ref OrdersRestApi

  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      StageName: 'default'
      DeploymentId: !Ref ApiGatewayDeployment
      RestApiId: !Ref OrdersRestApi
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: >-
          { "requestId": "$context.requestId", "sourceIp": "$context.identity.sourceIp" }

Outputs:
  ApiGatewayInvokeURL:
    Description: "The invoke URL for the deployed API stage"
    Value: !Sub 'https://${OrdersRestApi}.execute-api.${AWS::Region}.amazonaws.com/default'