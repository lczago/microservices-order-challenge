AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  CloudFormation template to create roles, policies and CloudWatch Log Group.

Parameters:
  ApplicationName:
    Type: String
    Description: The name of the application. Used to name the resources.

Resources:
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${ApplicationName}-api-gw"

  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: execution_role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - 'sts:AssumeRole'

  ExecutionRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: execution_role_policy
      Roles:
        - !Ref ExecutionRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'logs:CreateLogStream'
              - 'logs:CreateLogGroup'
              - 'logs:PutLogEvents'
              - 'logs:DescribeLogStreams'
              - 'secretsmanager:GetSecretValue'
              - 'ssm:GetParameters'
              - 'ecs:ExecuteCommand'
              - 'ssm:StartSession'
              - 'ecs:DescribeTasks'
              - 'ecs:ListClusters'
              - 'ecs:ListContainerInstances'
              - 'ecs:DescribeContainerInstances'
              - 'ssmmessages:CreateControlChannel'
              - 'ssmmessages:CreateDataChannel'
              - 'ssmmessages:OpenControlChannel'
              - 'ssmmessages:OpenDataChannel'
            Resource: '*'

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: task_role
      Path: "/"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - 'sts:AssumeRole'

  ApiGatewayCloudWatchLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: APIGatewayCloudWatchLogsRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: ApiGatewayCloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:DescribeLogGroups'
                  - 'logs:DescribeLogStreams'
                  - 'logs:PutLogEvents'
                  - 'logs:GetLogEvents'
                  - 'logs:FilterLogEvents'
                Resource: '*'

Outputs:
  ApiGatewayLogGroupName:
    Description: The name of the CloudWatch Log Group for the API Gateway.
    Value: !Ref ApiGatewayLogGroup
  ExecutionRoleArn:
    Description: ARN of the ECS Execution Role
    Value: !GetAtt ExecutionRole.Arn
    Export:
      Name: ExecutionRoleArn
  TaskRoleArn:
    Description: ARN of the ECS Task Role
    Value: !GetAtt TaskRole.Arn
    Export:
      Name: TaskRoleArn
  ApiGatewayCloudWatchLogsRoleArn:
    Description: ARN of the API Gateway CloudWatch Logs Role
    Value: !GetAtt ApiGatewayCloudWatchLogsRole.Arn
    Export:
      Name: ApiGatewayCloudWatchLogsRoleArn

